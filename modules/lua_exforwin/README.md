# lua-exforwin-module

# 2023-11-02 更新

将oslib中的函数列表替换到原生的os模块中，仅进行重名的函数替换，不会影响到其他未被修改到的函数。

实现原理：efw_init中luaopen_efw会调用oslib_ex的luaopen_os_ex，在这个函数中就会从全局的表中寻找os模块，然后替换os模块中重名的函数。

## 项目作用以及编码需知

模块的作用旨在于为Windows的UTF-16的的操作进行扩展，比如说文件io操作和执行command的操作，lua原生的操作在Windows上只支持ANSI，在简中环境上就是GBK编码，限制是很大的。

## 项目的初期目标

目标是实现print、execute、以及io能够正常使用，但是不会改动到lua的源代码，有一个方案，就是在本模块中实现上述目标，然后提供一个脚本，
在使用的时候，将lua原生的函数替换成本模块的函数。

## 备注

本模块为Windows下专用模块，因此有必要设计成如果在其他系统下强行编译本模块会得到空实现的库。

# 一点心里话

其实我并不想做这个模块，当初发现lua原生在Windows上使用有问题是因为我用os.execute执行命令行，发现命令执行出了问题，原因就是我的命令是UTF8字符串，且带了中文，所以出了问题，看了源码之后发现解决的方法很简单，那就是在Windows下的C库有提供窄字符串和宽字符串两种API，简单来说就是把UTF8字符串转为宽字符串，然后调宽字符串的API就可以了，但是因为其他系统并没有提供宽字符串的接口，所以就得搞兼容，想到这里就好烦，怪谁呢？怪Windows不用u8还是其它系统不用u16？其实都不能怪，只能怪时代的局限了（Windows全面换成UTF8应该是很难的，毕竟Windows就是搞兼容对吧，之前开过UTF8，结果有一些老软件的界面文字全变'?'了）。

窄字符串就是ASCII、GBK、UTF-8这些编码，它们使用一个或多个字节来表示一个字符，其中GBK与UTF-8都是兼容ASCII的，但是二者确实不相互兼容的，当要表示中文时，GBK是使用两个字节表示，UTF8则大多是用三个字节表示，如果用UTF8表示

实现这个模块，其实就是需要什么函数，就从原来的lualib中拷贝什么函数过来，然后添加宽字符串支持，依赖到什么函数就把什么函数搬过去，这个过程搬的过程相当无脑，但是要协调好就有点伤脑筋了，包括一个函数该不该暴露接口，是否是静态的。

在搬的过程中，我就会发现lua的源码中，比方说它把只有auxlib模块会用到的函数、结构体完全写在了lauxlib的源文件中，并且这些函数这个就使得我的移植操作得把更多的函数搬到我的模块中，


